import sys
from pathlib import Path

import pandas as pd

PROJECT_ROOT = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(PROJECT_ROOT / "src"))

from marketplace_search.eval.metrics import category_entropy_at_k, coverage_at_k, long_tail_at_k
from marketplace_search.retrieval.reranker import (
    ConstrainedExploreExploitConfig,
    build_exposure_store,
    novelty_bonus,
    rerank_with_constrained_explore_exploit,
    update_exposure_store,
)


def test_exposure_decay_and_novelty_bonus_decrease_with_exposure():
    store = build_exposure_store()
    cluster = "gifts"
    update_exposure_store(store, query_cluster_id=cluster, shown_product_ids=["p1"], decay=0.99, eval_k=10)
    first = novelty_bonus(cluster, "p1", store)
    update_exposure_store(store, query_cluster_id=cluster, shown_product_ids=["p1"], decay=0.99, eval_k=10)
    second = novelty_bonus(cluster, "p1", store)

    assert first < 1.0
    assert second < first


def test_constrained_exploration_and_diversity_cap():
    frame = pd.DataFrame(
        {
            "query_idx": [0, 0, 0, 0],
            "query_cluster_id": ["home", "home", "home", "home"],
            "query_cluster_entropy": [2.0, 2.0, 2.0, 2.0],
            "query_text": ["gift ideas", "gift ideas", "gift ideas", "gift ideas"],
            "candidate_product_id": ["p1", "p2", "p3", "p4"],
            "candidate_category": ["cat_a", "cat_a", "cat_a", "cat_b"],
            "base_score": [0.55, 0.54, 0.53, 0.5],
            "target_product_id": ["p4", "p4", "p4", "p4"],
        }
    )
    store = build_exposure_store()
    update_exposure_store(store, query_cluster_id="home", shown_product_ids=["p1", "p2", "p3"], decay=1.0, eval_k=10)
    update_exposure_store(store, query_cluster_id="home", shown_product_ids=["p1", "p2", "p3"], decay=1.0, eval_k=10)

    cfg = ConstrainedExploreExploitConfig(
        epsilon=1.0,
        alpha=1.0,
        top_pool_k=4,
        eval_k=3,
        max_per_category=1,
        broad_entropy_threshold=1.0,
        exposure_decay=1.0,
    )
    topk, _ = rerank_with_constrained_explore_exploit(frame, store, cfg, seed=7)

    ranked = topk.sort_values("final_rank")["candidate_product_id"].tolist()
    assert ranked[0] == "p4"
    assert topk["candidate_category"].value_counts().max() <= 2


def test_coverage_longtail_and_entropy_metrics():
    retrieved = [["a", "b", "c"], ["a", "d", "e"]]
    cats = [["x", "x", "y"], ["x", "z", "z"]]
    popularity_map = {"a": 100, "b": 1, "c": 2, "d": 1, "e": 100}

    assert coverage_at_k(retrieved, k=2, catalog_size=5) == 0.6
    assert long_tail_at_k(retrieved, popularity_map, bottom_quantile_threshold=2.0, k=2) == 0.5
    assert category_entropy_at_k(cats, k=3) > 0.0