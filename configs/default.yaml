# configs/default.yaml
# ─────────────────────────────────────────────
# Phase 0: Problem Framing & Metric Definition
# ─────────────────────────────────────────────

project:
  name: marketplace_search
  version: "0.1.0"
  seed: 42

paths:
  raw_reviews: data/raw/Arts_txt.gz
  raw_brands: data/raw/brands_txt.gz
  processed_dir: data/processed
  artifacts_dir: data/artifacts
  logs_dir: data/logs

data:
  # Implicit label thresholds
  positive_threshold: 4 # score >= 4  → positive interaction
  negative_threshold: 2 # score <= 2  → negative interaction
  # neutral: 3 (ignored by default)

  # Time-based split fractions (must sum to 1.0)
  train_frac: 0.70
  val_frac: 0.15
  test_frac: 0.15

  # Minimum interactions per user to be included
  min_user_interactions: 2

  # Minimum reviews per product to be included
  min_product_reviews: 1

evaluation:
  # Retrieval metrics
  recall_k: [1, 5, 10, 20, 50]
  ndcg_k: [5, 10, 20]
  mrr_k: 100 # cutoff for MRR computation

  # Personalization
  hit_rate_k: [5, 10, 20]

  # Repeat-user definition: users with >= this many interactions
  repeat_user_min_interactions: 3

  # System
  latency_percentiles: [50, 95, 99] # in ms
  max_p95_latency_ms: 100

logging:
  # Experiment bucketing
  num_buckets: 2
  hash_field: user_id

  # Impression log fields (informational — used in serving)
  impression_fields:
    - request_id
    - user_id
    - query_text
    - candidate_ids
    - predicted_scores
    - timestamp
    - experiment_bucket

# ─────────────────────────────────────────────
# Phase 1: Data Engineering & TF-IDF Retrieval
# ─────────────────────────────────────────────

catalog:
  max_summary_words: 30

queries:
  strategy: "title"
  ngram_sizes: [2, 3]
  max_queries_per_product: 3
  seed: 42

tfidf:
  max_features: 50000
  ngram_range: [1, 2]
  min_df: 1
  sublinear_tf: true
  retrieval_k: 200

# ─────────────────────────────────────────────
# Phase 2: Dual-Encoder Retrieval
# ─────────────────────────────────────────────
dual_encoder:
  model_name: sentence-transformers/all-MiniLM-L6-v2
  shared_weights: true
  max_length: 64
  batch_size: 32
  eval_batch_size: 64
  learning_rate: 2.0e-5
  weight_decay: 0.01
  epochs: 2
  grad_clip_norm: 1.0
  temperature: 0.05
  retrieval_k: 200
# ─────────────────────────────────────────────
# Phase 3: FAISS-Based Scalable Retrieval
# ─────────────────────────────────────────────
phase3:
  batch_size: 128
  query_batch_size: 64
  retrieval_k: 100

  # ANN choice: ivf_flat (or hnsw)
  ann_index_type: ivf_flat

  # IVF tuning knobs
  ivf_nlist_options: [64, 128, 256, 512]
  ivf_nprobe: 16

  # HNSW knobs (used when ann_index_type = hnsw)
  hnsw_m: 32
  hnsw_ef_search: 64

  # Targets
  target_p95_latency_ms: 50
  max_recall_drop: 0.02

# ─────────────────────────────────────────────
# Phase 4: Personalization Layer
# ─────────────────────────────────────────────
phase4:
  batch_size: 128
  ndcg_k: 10
  decay_lambda: 0.01
  alpha_grid: [0.2, 0.4, 0.6, 0.8, 1.0]
  catalog_embeddings_filename: phase3_catalog_embeddings.npy

# ─────────────────────────────────────────────
# Phase 5: Two-Stage Reranking
# ─────────────────────────────────────────────
phase5:
  batch_size: 128
  candidate_k: 200
  eval_k: 10
  hidden_dim: 32
  learning_rate: 1.0e-3
  weight_decay: 1.0e-4
  max_iter: 30
  ctr_smoothing: 10.0
  user_affinity_smoothing: 5.0
  catalog_embeddings_filename: phase3_catalog_embeddings.npy
# ─────────────────────────────────────────────
# Phase 6: Constrained Explore-Exploit Reranking
# ─────────────────────────────────────────────
phase6:
  batch_size: 128
  candidate_k: 200
  eval_k: 10
  use_reranker_prob: true

  # exposure + novelty
  exposure_decay: 0.99
  epsilon_grid: [0.0, 0.01, 0.05, 0.1]
  alpha_grid: [0.01, 0.05, 0.1]
  top_pool_k_grid: [50]

  # intent-aware diversity
  entropy_threshold: 1.0
  max_per_category_grid: [3]

  # long-tail metric
  long_tail_quantile: 0.2

  catalog_embeddings_filename: phase3_catalog_embeddings.npy
